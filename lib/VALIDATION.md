# G-code Validation Tool

This document describes how to use the G-code validation tool to compare G-code generated by the Rust slicer against reference G-code from BambuStudio.

## Overview

The validation tool provides a comprehensive comparison between two G-code files, analyzing:

- **Layer structure** - Number of layers and Z heights
- **Extrusion amounts** - Total and per-layer filament usage
- **Move counts** - Number of G-code commands
- **Travel distances** - Non-extruding movements
- **Feature classification** - Perimeters, infill, support, etc.

A **quality score** (0-100) is computed based on weighted factors, allowing you to quantify how close the Rust slicer output is to BambuStudio's reference.

## Quick Start

### Compare Two G-code Files Directly

```bash
# Basic comparison with default settings
slicer-cli validate model.stl reference.gcode --compare-only --generated rust_output.gcode

# Generate HTML report
slicer-cli validate model.stl reference.gcode --compare-only --generated rust_output.gcode \
    --format html --output report.html
```

### Slice and Compare in One Step

```bash
# Slice the STL and compare against reference
slicer-cli validate model.stl reference.gcode --layer-height 0.2 --perimeters 3

# With custom settings to match reference
slicer-cli validate model.stl reference.gcode \
    --layer-height 0.2 \
    --first-layer-height 0.2 \
    --perimeters 3 \
    --infill-density 15
```

## Command Line Options

| Option | Default | Description |
|--------|---------|-------------|
| `--tolerance` | `default` | Tolerance level: `strict`, `default`, or `relaxed` |
| `--output` | (stdout) | Output report file path |
| `--format` | `text` | Output format: `text`, `json`, or `html` |
| `--layer-height` | `0.2` | Layer height in mm |
| `--first-layer-height` | `0.2` | First layer height in mm |
| `--perimeters` | `3` | Number of perimeter shells |
| `--infill-density` | `15` | Infill density (0-100%) |
| `--pass-threshold` | `70` | Minimum quality score to pass (0-100) |
| `--compare-only` | false | Skip slicing, compare existing G-code files |
| `--generated` | - | Path to pre-generated G-code (with `--compare-only`) |

## Tolerance Levels

### Strict
- Layer count tolerance: 1%
- Total extrusion tolerance: 5%
- Per-layer extrusion tolerance: 10%
- Z tolerance: 0.001mm
- Pass threshold: 90

### Default
- Layer count tolerance: 5%
- Total extrusion tolerance: 10%
- Per-layer extrusion tolerance: 20%
- Z tolerance: 0.01mm
- Pass threshold: 70

### Relaxed
- Layer count tolerance: 10%
- Total extrusion tolerance: 20%
- Per-layer extrusion tolerance: 30%
- Z tolerance: 0.05mm
- Pass threshold: 50

## Quality Score

The quality score is computed from weighted components:

| Component | Weight | Description |
|-----------|--------|-------------|
| Layer Count | 20% | Accuracy of layer count vs reference |
| Total Extrusion | 30% | Accuracy of total filament usage |
| Layer Consistency | 25% | Average per-layer extrusion accuracy |
| Coverage | 15% | Similarity of total move counts |
| Features | 10% | Presence of expected feature types |

## Output Formats

### Text Report

```
═══════════════════════════════════════════════════════════════════
                    G-CODE VALIDATION REPORT
═══════════════════════════════════════════════════════════════════

Status: ✓ PASSED (Score: 85.2/100)

Files:
  Reference: /path/to/reference.gcode
  Generated: /path/to/generated.gcode

───────────────────────────────────────────────────────────────────
SUMMARY
───────────────────────────────────────────────────────────────────
  Layer Count:          240 vs      242  (+0.8%)
  Total Extrusion:  3869.22mm vs  3945.10mm  (+2.0%)
  Total Moves:       186432 vs   189201  (+2769)
  Travel Distance:  4521.50mm vs  4680.32mm  (+3.5%)
  Z Range:          0.200mm - 48.000mm

───────────────────────────────────────────────────────────────────
SCORE BREAKDOWN
───────────────────────────────────────────────────────────────────
  Layer Count:        99.2 × 20% =  19.84
  Total Extrusion:    98.0 × 30% =  29.40
  Layer Consistency:  82.5 × 25% =  20.63
  Coverage:           97.1 × 15% =  14.57
  Features:          100.0 × 10% =  10.00
  ─────────────────────────────────────
  TOTAL:                          85.2/100
```

### JSON Report

```json
{
  "quality_score": 85.2,
  "passed": true,
  "summary": {
    "ref_layer_count": 240,
    "gen_layer_count": 242,
    "layer_count_diff_percent": 0.83,
    "ref_total_extrusion": 3869.22,
    "gen_total_extrusion": 3945.10,
    "extrusion_diff_percent": 1.96
  },
  "issues": [],
  "score_breakdown": {
    "layer_count_score": 99.17,
    "total_extrusion_score": 98.04,
    "layer_consistency_score": 82.50,
    "coverage_score": 97.08,
    "feature_score": 100.0
  }
}
```

### HTML Report

The HTML report provides a styled, browser-viewable report with:
- Color-coded pass/fail status
- Visual score bar
- Interactive issue list
- Sortable tables

## Programmatic Usage

### Rust API

```rust
use slicer::gcode::validation::{ValidationReport, ValidationConfig};
use slicer::gcode::compare::ParsedGCode;

// Load G-code files
let reference = ParsedGCode::from_file("reference.gcode")?;
let generated = ParsedGCode::from_file("generated.gcode")?;

// Run validation
let config = ValidationConfig::default();
let report = ValidationReport::generate(&reference, &generated, config);

// Check results
println!("Quality Score: {:.1}", report.quality_score());
println!("Passed: {}", report.passed());

// Generate text report
println!("{}", report.to_text());

// Generate JSON for automation
let json = report.to_json()?;

// Write HTML report
report.write_to_file("report.html", ReportFormat::Html)?;
```

### Custom Configuration

```rust
use slicer::gcode::validation::ValidationConfig;

let mut config = ValidationConfig::default();
config.layer_count_tolerance = 0.03;  // 3% tolerance
config.total_extrusion_tolerance = 0.08;  // 8% tolerance
config.pass_threshold = 80.0;  // Require 80% score to pass

// Or use presets
let strict = ValidationConfig::strict();
let relaxed = ValidationConfig::relaxed();
```

## Issue Severity Levels

| Severity | Description |
|----------|-------------|
| **CRITICAL** | Print will likely fail (>20% layer count diff, >25% extrusion diff) |
| **ERROR** | Significant quality issue (>10% layer diff, >15% extrusion diff) |
| **WARNING** | Minor quality issue (within tolerance but notable) |
| **INFO** | Informational only |

## Best Practices

### For Accurate Comparisons

1. **Match slicer settings**: Use the same layer height, perimeters, and infill density as the reference G-code
2. **Use the same model**: Ensure the STL file is identical to what BambuStudio sliced
3. **Check reference settings**: Extract settings from the reference G-code header comments

### For CI/CD Integration

```bash
# Exit with non-zero status if validation fails
slicer-cli validate model.stl reference.gcode --pass-threshold 75
echo $?  # 0 = passed, 1 = failed

# Generate JSON for automated parsing
slicer-cli validate model.stl reference.gcode \
    --compare-only --generated output.gcode \
    --format json --output results.json
```

### For Debugging

```bash
# Use verbose mode to see detailed progress
slicer-cli validate model.stl reference.gcode -v

# Generate detailed HTML report for visual inspection
slicer-cli validate model.stl reference.gcode \
    --format html --output debug_report.html

# Use relaxed tolerance to see all differences
slicer-cli validate model.stl reference.gcode --tolerance relaxed
```

## Example Workflow

1. **Generate reference G-code** from BambuStudio with known settings
2. **Run validation** with matching settings:
   ```bash
   slicer-cli validate 3DBenchy.stl reference_benchy.gcode \
       --layer-height 0.2 \
       --perimeters 3 \
       --infill-density 15 \
       --output validation_report.html \
       --format html
   ```
3. **Review the report** to identify discrepancies
4. **Iterate** on the Rust slicer implementation to improve the quality score

## Limitations

- **Semantic comparison**: The tool compares structural similarity, not byte-for-byte equality
- **Feature detection**: Feature classification relies on G-code comments; uncommented moves are classified as "Unknown"
- **Timing**: Print time estimates are not currently compared
- **Multi-material**: Multi-extruder toolpath comparison is limited

## Related Files

- `src/gcode/compare.rs` - Core comparison infrastructure
- `src/gcode/validation.rs` - Validation report generation
- `tests/benchy_integration.rs` - Integration tests using the comparator