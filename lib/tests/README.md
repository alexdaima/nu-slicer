# Slicer Integration Tests

This directory contains integration tests for validating the Rust slicer implementation against reference G-code generated by BambuStudio.

## Directory Structure

```
tests/
├── README.md                    # This file
├── benchy_integration.rs        # 3DBenchy validation tests
```

## Test Data

Test data files are stored in `../data/`:

```
data/
├── test_stls/                   # Input STL files for testing
│   └── 3DBenchy.stl            # Classic 3D printing benchmark model
│
└── reference_gcodes/            # BambuStudio-generated reference G-code
    └── 3DBenchy.gcode          # Reference output (Bambu H2D + Bambu PLA Basic)
```

## Reference G-code Settings

The reference 3DBenchy.gcode was generated with:

- **Printer**: Bambu Lab H2D
- **Filament**: Bambu PLA Basic
- **Layer Height**: 0.2mm
- **Initial Layer Height**: 0.2mm
- **Wall Loops**: 2
- **Top Shell Layers**: 5
- **Bottom Shell Layers**: 3
- **Infill Pattern**: Grid
- **Nozzle Diameter**: 0.4mm

Key statistics from the reference:
- **Total Layers**: 240
- **Max Z Height**: 48.0mm
- **Print Time**: ~33 minutes
- **Filament Length**: 3869.22mm

## Current Implementation Status

The slicer now has a complete pipeline that can:

1. **Load STL files** - Parse binary and ASCII STL formats
2. **Slice meshes into layers** - Generate layer contours at specified Z heights
3. **Generate perimeters** - Create inner/outer perimeter loops
4. **Generate infill** - Rectilinear, grid, and concentric patterns
5. **Convert to toolpaths** - ExtrusionPath objects with width, height, speed
6. **Generate G-code** - Full G-code output with proper extrusion calculations

### Pipeline Usage

```rust
use slicer::pipeline::{PipelineConfig, PrintPipeline};
use slicer::mesh::load_stl;

let mesh = load_stl("model.stl")?;
let config = PipelineConfig::new()
    .layer_height(0.2)
    .perimeters(3)
    .infill_density(0.15);

let pipeline = PrintPipeline::new(config);
let gcode = pipeline.process(&mesh)?;
gcode.write_to_file("output.gcode")?;
```

### CLI Usage

```bash
# Slice an STL file
slicer-cli slice model.stl -o output.gcode --layer-height 0.2 --perimeters 3

# Get model info
slicer-cli info model.stl
```

## Running Tests

```bash
# Run all integration tests
cargo test --test benchy_integration

# Run with verbose output
cargo test --test benchy_integration -- --nocapture

# Run a specific test
cargo test --test benchy_integration test_benchy_stl_loads_successfully

# Run only pipeline tests
cargo test --test benchy_integration pipeline
```

## Test Categories

### Currently Passing (19 tests)

1. **File Existence Tests**
   - `test_benchy_stl_exists` - Verifies STL file is present
   - `test_benchy_reference_gcode_exists` - Verifies reference G-code is present

2. **STL Loading Tests**
   - `test_benchy_stl_loads_successfully` - Loads and validates mesh
   - `test_benchy_mesh_bounding_box` - Validates mesh dimensions (~60x31x48mm)
   - `test_benchy_mesh_is_valid` - Checks all triangles have valid vertices

3. **Reference G-code Parsing Tests**
   - `test_reference_gcode_header_parsing` - Parses BambuStudio settings
   - `test_reference_gcode_layer_count` - Validates 240 layers
   - `test_reference_gcode_z_heights` - Validates layer Z progression
   - `test_reference_gcode_has_valid_moves` - Counts and validates G-code moves
   - `test_reference_gcode_complete_parse` - Full file analysis
   - `test_gcode_move_parsing` - Unit tests for G-code command parsing

4. **Slicing Comparison Tests**
   - `test_slicing_produces_correct_layer_count` - Layer count matches reference
   - `test_slicing_layer_heights_match_reference` - Z heights align with reference
   - `test_slicing_produces_actual_geometry` - Verifies layer geometry
   - `test_slicing_performance` - Ensures slicing completes in <30s

5. **Pipeline Integration Tests** (NEW)
   - `test_pipeline_generates_gcode_for_benchy` - Full pipeline execution
   - `test_pipeline_layer_count_reasonable` - Layer count within 10% of reference
   - `test_pipeline_extrusion_reasonable` - Total extrusion in valid range
   - `test_pipeline_gcode_stats` - Statistics tracking validation

### Pending Implementation (5 tests, currently ignored)

These tests require closer parity with BambuStudio output:

1. `test_generated_gcode_layer_count_matches` - Exact G-code layer parity
2. `test_generated_gcode_total_extrusion_matches` - Exact filament usage
3. `test_generated_gcode_print_time_estimate` - Print time estimation
4. `test_toolpath_semantic_equivalence` - Detailed toolpath comparison
5. `test_gcode_byte_level_parity` - Exact byte-for-byte G-code matching

## Adding New Test Models

To add more test cases:

1. Place the STL file in `data/test_stls/`
2. Generate reference G-code using BambuStudio with documented settings
3. Place the G-code in `data/reference_gcodes/`
4. Add corresponding test functions to `benchy_integration.rs` or create a new test file

## Validation Strategy

### Phase 1: Layer Height Parity ✅ (Complete)
- Verify layer count matches
- Verify Z heights align within tolerance

### Phase 2: Basic G-code Generation ✅ (Complete)
- Generate valid G-code with proper structure
- Calculate extrusion amounts correctly
- Handle travel moves and retractions

### Phase 3: Semantic Equivalence (In Progress)
- Compare toolpath structure (perimeters, infill, travel)
- Compare total extrusion amounts within tolerance (~6% currently)
- Compare feature counts (walls, bridges, supports)

### Phase 4: Byte-Level Parity (Future)
- Exact G-code text matching
- Requires deterministic algorithms and precise formatting
- Match BambuStudio's exact seam placement, ordering, and formatting

## Current Results

When slicing 3DBenchy with similar settings:

| Metric | Reference (BambuStudio) | Rust Slicer | Difference |
|--------|------------------------|-------------|------------|
| Layers | 240 | 240 | 0% |
| Filament | 3869.22mm | ~3640mm | ~6% |
| G-code lines | - | ~431,000 | - |

The 6% difference in filament usage is primarily due to:
- Different infill pattern spacing/density calculations
- Different seam placement strategies
- Perimeter ordering differences